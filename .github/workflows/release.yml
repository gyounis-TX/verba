name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies and build sidecar
        run: |
          cd sidecar
          python -m venv .venv
          .venv/bin/pip install -r requirements.txt
          .venv/bin/pip install pyinstaller
          .venv/bin/pyinstaller sidecar.spec --distpath ../src-tauri/binaries
          cd ..
          # Tauri expects the binary name with target triple suffix
          TRIPLE=$(rustc -vV | grep host | awk '{print $2}')
          mv src-tauri/binaries/sidecar "src-tauri/binaries/sidecar-${TRIPLE}"

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Explify ${{ github.ref_name }}'
          releaseBody: 'See the assets to download and install this version.'
          releaseDraft: false
          prerelease: false

      - name: Sign and upload updater artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          TARGZ=$(ls src-tauri/target/release/bundle/macos/*.app.tar.gz 2>/dev/null | head -1)
          if [ -n "$TARGZ" ]; then
            echo "Signing $TARGZ"
            npx tauri signer sign "$TARGZ"
            echo "Uploading ${TARGZ}.sig"
            gh release upload "${{ github.ref_name }}" "${TARGZ}.sig" --clobber
          fi

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies and build sidecar
        shell: bash
        run: |
          cd sidecar
          python -m venv .venv
          .venv/Scripts/pip install -r requirements.txt
          .venv/Scripts/pip install pyinstaller
          .venv/Scripts/pyinstaller sidecar.spec --distpath ../src-tauri/binaries
          cd ..
          # Tauri expects the binary name with target triple suffix
          TRIPLE=$(rustc -vV | grep host | awk '{print $2}')
          mv "src-tauri/binaries/sidecar.exe" "src-tauri/binaries/sidecar-${TRIPLE}.exe"

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Explify ${{ github.ref_name }}'
          releaseBody: 'See the assets to download and install this version.'
          releaseDraft: false
          prerelease: false

      - name: Create and upload updater bundle
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          EXE=$(ls src-tauri/target/release/bundle/nsis/*-setup.exe 2>/dev/null | head -1)
          if [ -n "$EXE" ]; then
            NSIS_ZIP="${EXE%.exe}.nsis.zip"
            echo "Creating $NSIS_ZIP"
            powershell.exe -Command "Compress-Archive -Path '$EXE' -DestinationPath '$NSIS_ZIP'"
            echo "Signing $NSIS_ZIP"
            npx tauri signer sign "$NSIS_ZIP"
            echo "Uploading $NSIS_ZIP and ${NSIS_ZIP}.sig"
            gh release upload "${{ github.ref_name }}" "$NSIS_ZIP" --clobber
            gh release upload "${{ github.ref_name }}" "${NSIS_ZIP}.sig" --clobber
          fi

  create-updater-json:
    needs: [build-macos, build-windows]
    if: always() && (needs.build-macos.result == 'success' || needs.build-windows.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Create latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Download all sig files from the release
          mkdir -p sigs
          gh release download "$TAG" --repo "$REPO" --pattern "*.sig" --dir sigs 2>/dev/null || true

          # Get list of release assets
          ASSETS=$(gh release view "$TAG" --repo "$REPO" --json assets --jq '.assets[].name')

          # Start building platforms JSON
          PLATFORMS='{}'

          # macOS (darwin-aarch64)
          MACOS_ASSET=$(echo "$ASSETS" | grep '\.app\.tar\.gz$' | head -1)
          MACOS_SIG_FILE=$(ls sigs/*.app.tar.gz.sig 2>/dev/null | head -1)
          if [ -n "$MACOS_ASSET" ] && [ -n "$MACOS_SIG_FILE" ]; then
            MACOS_SIG=$(cat "$MACOS_SIG_FILE")
            PLATFORMS=$(echo "$PLATFORMS" | jq \
              --arg url "${BASE_URL}/${MACOS_ASSET}" \
              --arg sig "$MACOS_SIG" \
              '. + {"darwin-aarch64": {"signature": $sig, "url": $url}}')
          fi

          # Windows (windows-x86_64)
          WINDOWS_ASSET=$(echo "$ASSETS" | grep '\.nsis\.zip$' | head -1)
          WINDOWS_SIG_FILE=$(ls sigs/*.nsis.zip.sig 2>/dev/null | head -1)
          if [ -n "$WINDOWS_ASSET" ] && [ -n "$WINDOWS_SIG_FILE" ]; then
            WINDOWS_SIG=$(cat "$WINDOWS_SIG_FILE")
            PLATFORMS=$(echo "$PLATFORMS" | jq \
              --arg url "${BASE_URL}/${WINDOWS_ASSET}" \
              --arg sig "$WINDOWS_SIG" \
              '. + {"windows-x86_64": {"signature": $sig, "url": $url}}')
          fi

          # Create latest.json
          jq -n \
            --arg version "$VERSION" \
            --arg notes "See the assets to download and install this version." \
            --arg pub_date "$DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' \
            > latest.json

          echo "Generated latest.json:"
          cat latest.json

          gh release upload "$TAG" latest.json --clobber --repo "$REPO"
