name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --repo "${{ github.repository }}" \
            --title "Explify ${{ github.ref_name }}" \
            --notes "See the assets to download and install this version." \
            2>/dev/null || true

  build-macos:
    needs: create-release
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies and build sidecar
        run: |
          cd sidecar
          python -m venv .venv
          .venv/bin/pip install -r requirements.txt
          .venv/bin/pip install pyinstaller
          .venv/bin/pyinstaller sidecar.spec --distpath ../src-tauri/binaries
          cd ..
          # Tauri expects the binary name with target triple suffix
          TRIPLE=$(rustc -vV | grep host | awk '{print $2}')
          mv src-tauri/binaries/sidecar "src-tauri/binaries/sidecar-${TRIPLE}"

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: npx tauri build

      - name: List build artifacts
        run: |
          echo "=== macos bundle ==="
          ls -la src-tauri/target/release/bundle/macos/ 2>/dev/null || echo "No macos bundle dir"
          echo "=== dmg bundle ==="
          ls -la src-tauri/target/release/bundle/dmg/ 2>/dev/null || echo "No dmg bundle dir"

      - name: Upload release artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          REPO="${{ github.repository }}"

          upload_with_retry() {
            local file="$1" attempt
            for attempt in 1 2 3; do
              echo "Uploading $file (attempt $attempt)..."
              if gh release upload "$TAG" "$file" --clobber --repo "$REPO"; then
                return 0
              fi
              echo "Attempt $attempt failed, retrying in 5s..."
              sleep 5
            done
            echo "ERROR: Failed to upload $file after 3 attempts"
            return 1
          }

          FAILED=0
          for f in src-tauri/target/release/bundle/macos/*.app.tar.gz \
                   src-tauri/target/release/bundle/macos/*.app.tar.gz.sig \
                   src-tauri/target/release/bundle/dmg/*.dmg; do
            [ -f "$f" ] && upload_with_retry "$f" || FAILED=1
          done
          exit $FAILED

  build-windows:
    needs: create-release
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies and build sidecar
        shell: bash
        run: |
          cd sidecar
          python -m venv .venv
          .venv/Scripts/pip install -r requirements.txt
          .venv/Scripts/pip install pyinstaller
          .venv/Scripts/pyinstaller sidecar.spec --distpath ../src-tauri/binaries
          cd ..
          # Tauri expects the binary name with target triple suffix
          TRIPLE=$(rustc -vV | grep host | awk '{print $2}')
          mv "src-tauri/binaries/sidecar.exe" "src-tauri/binaries/sidecar-${TRIPLE}.exe"

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: npx tauri build

      - name: List build artifacts
        shell: bash
        run: |
          echo "=== nsis bundle ==="
          ls -la src-tauri/target/release/bundle/nsis/ 2>/dev/null || echo "No nsis bundle dir"

      - name: Upload release artifacts
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          REPO="${{ github.repository }}"

          upload_with_retry() {
            local file="$1" attempt
            for attempt in 1 2 3; do
              echo "Uploading $file (attempt $attempt)..."
              if gh release upload "$TAG" "$file" --clobber --repo "$REPO"; then
                return 0
              fi
              echo "Attempt $attempt failed, retrying in 5s..."
              sleep 5
            done
            echo "ERROR: Failed to upload $file after 3 attempts"
            return 1
          }

          FAILED=0
          for f in src-tauri/target/release/bundle/nsis/*-setup.exe \
                   src-tauri/target/release/bundle/nsis/*.nsis.zip \
                   src-tauri/target/release/bundle/nsis/*.nsis.zip.sig; do
            [ -f "$f" ] && upload_with_retry "$f" || FAILED=1
          done
          exit $FAILED

  create-updater-json:
    needs: [build-macos, build-windows]
    if: always() && (needs.build-macos.result == 'success' || needs.build-windows.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Create latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Download all sig files from the release
          mkdir -p sigs
          gh release download "$TAG" --repo "$REPO" --pattern "*.sig" --dir sigs 2>/dev/null || true

          echo "=== Downloaded sig files ==="
          ls -la sigs/

          # Get list of release assets
          ASSETS=$(gh release view "$TAG" --repo "$REPO" --json assets --jq '.assets[].name')

          echo "=== Release assets ==="
          echo "$ASSETS"

          # Start building platforms JSON
          PLATFORMS='{}'

          # macOS (darwin-aarch64)
          MACOS_ASSET=$(echo "$ASSETS" | grep '\.app\.tar\.gz$' | head -1)
          MACOS_SIG_FILE=$(ls sigs/*.app.tar.gz.sig 2>/dev/null | head -1)
          if [ -n "$MACOS_ASSET" ] && [ -n "$MACOS_SIG_FILE" ]; then
            MACOS_SIG=$(cat "$MACOS_SIG_FILE")
            PLATFORMS=$(echo "$PLATFORMS" | jq \
              --arg url "${BASE_URL}/${MACOS_ASSET}" \
              --arg sig "$MACOS_SIG" \
              '. + {"darwin-aarch64": {"signature": $sig, "url": $url}}')
          fi

          # Windows (windows-x86_64)
          WINDOWS_ASSET=$(echo "$ASSETS" | grep '\.nsis\.zip$' | head -1)
          WINDOWS_SIG_FILE=$(ls sigs/*.nsis.zip.sig 2>/dev/null | head -1)
          if [ -n "$WINDOWS_ASSET" ] && [ -n "$WINDOWS_SIG_FILE" ]; then
            WINDOWS_SIG=$(cat "$WINDOWS_SIG_FILE")
            PLATFORMS=$(echo "$PLATFORMS" | jq \
              --arg url "${BASE_URL}/${WINDOWS_ASSET}" \
              --arg sig "$WINDOWS_SIG" \
              '. + {"windows-x86_64": {"signature": $sig, "url": $url}}')
          fi

          # Create latest.json
          jq -n \
            --arg version "$VERSION" \
            --arg notes "See the assets to download and install this version." \
            --arg pub_date "$DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' \
            > latest.json

          echo "Generated latest.json:"
          cat latest.json

          gh release upload "$TAG" latest.json --clobber --repo "$REPO"
